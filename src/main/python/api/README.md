# 沙粒图像处理集成

本文档描述了沙粒图像处理API与前端的集成过程。

## 架构概述

系统由以下部分组成：

1. **后端API** - 基于FastAPI，实现了沙粒图像处理功能
   - 部署在 `/api/sand/` 路径下
   - 提供了图像处理、分析、批量操作等功能

2. **前端接口** - 基于Axios，实现了与后端API通信的功能
   - 位于 `src/renderer/src/api/sandImageApi.js`
   - 提供了进度跟踪、异步处理等功能

3. **数据展示组件** - Vue组件，展示分析结果
   - 位于 `src/renderer/src/components/DataReport.vue`
   - 使用ECharts绘制图表和结果展示

## 数据流程

整个沙粒数据处理流程如下：

1. **数据采集** - 从相机或文件系统获取沙粒图像
2. **灰度化处理** - 将彩色图像转为灰度图，便于处理
3. **砂粒识别** - 利用图像处理算法识别图像中的砂粒
4. **砂粒分割** - 分割不同的砂粒，解决重叠问题
5. **信息提取** - 提取砂粒的尺寸、形状等特征
6. **数据分析** - 分析粒径分布、MX值等关键指标
7. **结果展示** - 在前端展示分析结果、统计图表等

## API接口清单

以下是主要API接口：

- `/api/sand/process-images` - 处理上传的沙粒图像
- `/api/sand/task-status/{task_id}` - 获取任务状态
- `/api/sand/process-directory` - 批量处理目录中的图像
- `/api/sand/analyze` - 分析沙粒数据
- `/api/sand/refine-data` - 精炼图像数据
- `/api/sand/draw-grades` - 绘制沙粒等级分布

详细API文档见 [API_DOCS.md](API_DOCS.md)。

## 使用方法

### 启动API服务器

```bash
cd src/main/python/api
python start_api_server.py
```

### 运行API测试

```bash
cd src/main/python/api
python test_sand_api.py
```

### 开发和测试

1. 启动API服务器
2. 启动前端开发服务器
3. 使用DataReport组件查看分析结果

### 生产部署

在生产环境中，API服务器和前端应用将一起部署，共用同一域名。

## 注意事项

1. API处理大图像可能需要较长时间，请设置合适的超时时间
2. 大量图像处理可能占用大量内存，请确保服务器有足够内存
3. 批量处理任务状态需要通过轮询获取，前端代码中已实现相关逻辑

## 常见问题

1. **API连接失败**
   - 检查API服务器是否已启动
   - 检查URL路径是否正确
   - 检查网络连接和防火墙设置

2. **图像处理失败**
   - 检查图像格式是否支持
   - 检查图像质量是否足够
   - 检查背景模型是否正确加载

3. **数据分析结果不正确**
   - 检查样本索引是否正确
   - 检查图像类型是否选择正确
   - 检查分析参数是否设置正确
